@page "/registar"
@layout SpecialLayout
@inject NavigationManager NavigationManager
@using DataLayer.Utilizador
@inject IUtilizadorRepository _db
@inject IJSRuntime js


<form action="/register" method="post" asp-modal="true" @onsubmit="RegisterUser">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h1 class="modal-title">Registar</h1>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">Nome de utilizador:</label>
                    <input type="text" id="username" name="username" placeholder="Nome de Utilizador" class="form-control" @bind="nome">
                </div>

                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" placeholder="Senha" class="form-control">
                </div>

                <hr>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar senha:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirmar senha" class="form-control" @bind="password">
                </div>
                
                <div class="form-group">
                    <label>Foto de perfil</label>
                    <InputFile OnChange="HandleFileInput" class="form-control"/>
                </div>
            </div>
            

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary btn-block">Registar</button>
            </div>

        </div>
    </div>
</form>



<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="card mt-3" style="display: @(showMessageBox ? "block" : "none")">
            <div class="card-body text-center">
                <p>Registo foi um sucesso!</p>
            </div>
        </div>
    </div>
</div>


@code {
    private string nome;
    private string password;
    private bool showMessageBox = false;
    private byte[] img;

    private async Task HandleFileInput(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using (var stream = file.OpenReadStream())
        {
            var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            img = memoryStream.ToArray();
        }
    }

    private async Task RegisterUser()
    {
        Console.WriteLine("AQUI-----------------------------------------------------");
        Console.WriteLine($"nome: {nome}");
        Console.WriteLine($"password: {password}");

        var novoUtilizador = new UtilizadorModel
            {
                username = nome,
                password = password,
                avaliacaoMedia = 0,
                numeroDeLeiloesFeitos = 0,
                dataDeRegisto = DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss"),
                fotoPerfil = img
            };

        UtilizadorModel userFounded = await _db.Find(nome);
        if(userFounded == null)
        {
            
            await _db.Create(novoUtilizador);
            await js.InvokeVoidAsync("alert", "Utilizador criado com sucesso");
            NavigationManager.NavigateTo("/");
        } else
        {
            await js.InvokeVoidAsync("alert", "Utilizador já existente");
            return;
        }

        //showMessageBox = true;
        // StateHasChanged();

        //await Task.Delay(1000);

        //NavigationManager.NavigateTo("/");
    }
}
