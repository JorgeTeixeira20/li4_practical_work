@page "/registar"
@layout SpecialLayout
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using DataLayer.Utilizador
@inject IUtilizadorRepository _db


<form action="/register" method="post" asp-modal="true" @onsubmit="RegisterUser">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h1 class="modal-title">Registar</h1>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="email">Endereço de e-mail:</label>
                    <input type="email" id="email" name="email" placeholder="Endereço de e-mail" class="form-control" @bind="nome">
                </div>

                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" placeholder="Senha" class="form-control">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar senha:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirmar senha" class="form-control" @bind="password">
                </div>

                <hr>

                <div class="flex-item100percent">
                    <label>Insira uma Imagem:</label>
                    <div></div>
                    <InputFile multiple OnChange="HandleFileInput" />
                </div>

            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary btn-block">Registar</button>
            </div>
        </div>
    </div>
</form>



<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="card mt-3" style="display: @(showMessageBox ? "block" : "none")">
            <div class="card-body text-center">
                <p>Registado com sucesso!</p>
            </div>
        </div>
    </div>
</div>


@code {
    private string nome;
    private string password;
    private bool showMessageBox = false;

    private byte[] imagemDeRei; // Alterada para ser um array de bytes

    private async Task HandleFileInput(InputFileChangeEventArgs e)
    {
        var file = e.File;

        using (var stream = file.OpenReadStream())
        {
            var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            imagemDeRei = memoryStream.ToArray();
        }
    }

    private async Task RegisterUser()
    {
        Console.WriteLine("AQUI-----------------------------------------------------");
        Console.WriteLine($"nome: {nome}");
        Console.WriteLine($"password: {password}");

        var novoUtilizador = new UtilizadorModel
            {
                username = nome,
                password = password,
                avaliacaoMedia = 0,
                numeroDeLeiloesFeitos = 0,
                dataDeRegisto = DateTime.UtcNow.ToString("yyyy-MM-dd HH:mm:ss"),
                Imagem = imagemDeRei
            };

        await _db.Create(novoUtilizador);

        showMessageBox = true;
        StateHasChanged();

        await Task.Delay(1000);

        NavigationManager.NavigateTo("/");
    }
}
